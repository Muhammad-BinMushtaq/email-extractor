<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìß Email Scraper & Campaign Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group input[type="text"],
        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="url"] {
            flex: 1;
            min-width: 200px;
        }

        .input-group textarea {
            width: 100%;
            min-height: 120px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            padding: 12px 20px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .btn-secondary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #667eea;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.active {
            display: block;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }

        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .results-count {
            font-size: 1.1em;
            color: #333;
            font-weight: 600;
        }

        .results-count span {
            color: #667eea;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tbody tr:hover {
            background: #f8f9fa;
        }

        table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .email-cell {
            color: #667eea;
            word-break: break-all;
        }

        .action-btn {
            background: #e0e0e0;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 1.1em;
        }

        .email-draft {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-results {
            margin-top: 20px;
        }

        .send-result-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .send-result-item.sent {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .send-result-item.failed {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
            }

            table {
                font-size: 0.9em;
            }

            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email Scraper & Campaign Manager</h1>
            <p>Extract emails, draft campaigns, and send outreach emails</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('scrape', this)">üîç Scrape Emails</button>
            <button class="tab-btn" onclick="switchTab('draft', this)">‚úçÔ∏è Draft Email</button>
            <button class="tab-btn" onclick="switchTab('send', this)">üì§ Send Campaign</button>
        </div>

        <!-- SCRAPE TAB -->
        <div id="scrape" class="tab-content active">
            <div class="card">
                <h2>Web Scraper</h2>
                <p style="color: #999; margin-bottom: 20px;">Extract email addresses from any website</p>

                <div class="input-group">
                    <input 
                        type="url" 
                        id="urlInput" 
                        placeholder="Enter website URL (e.g., https://example.com)" 
                        value="https://www.uc3m.es/orientacionyempleo/somos#campusgetafe"
                    >
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="scrapeEmails()">Scrape Emails</button>
                    <button class="btn-secondary" id="exportBtn" onclick="exportToCSV()" disabled>üì• Export to CSV</button>
                    <button class="btn-secondary" onclick="clearResults()">Clear</button>
                </div>

                <div class="message error" id="errorMsg"></div>
                <div class="message success" id="successMsg"></div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Scraping website...</p>
                </div>

                <div id="results"></div>
            </div>
        </div>

        <!-- DRAFT TAB -->
        <div id="draft" class="tab-content">
            <div class="card">
                <h2>Email Draft Generator</h2>
                <p style="color: #999; margin-bottom: 20px;">Generate professional email drafts</p>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email Subject</label>
                        <input type="text" id="emailSubject" placeholder="e.g., Partnership Opportunity">
                    </div>
                    <div class="form-group">
                        <label>Target Company</label>
                        <input type="text" id="targetCompany" placeholder="e.g., Google, Microsoft">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email Purpose</label>
                        <textarea id="emailPurpose" placeholder="e.g., Job inquiry, partnership proposal, sales pitch"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="generateEmailDraft()">Generate Draft</button>
                    <button class="btn-secondary" id="saveDraftBtn" onclick="saveDraftPrompt()" disabled>üíæ Save Draft</button>
                    <button class="btn-secondary" onclick="showLoadedDrafts()">üìÇ Load Draft</button>
                </div>

                <div class="message error" id="draftErrorMsg"></div>
                <div class="message success" id="draftSuccessMsg"></div>

                <div class="loading" id="draftLoading">
                    <div class="spinner"></div>
                    <p>Generating email...</p>
                </div>

                <div id="draftResult"></div>
                <div id="savedDraftsPanel"></div>
            </div>
        </div>

        <!-- SEND TAB -->
        <div id="send" class="tab-content">
            <div class="card">
                <h2>Send Email Campaign</h2>
                <p style="color: #999; margin-bottom: 20px;">Send emails to multiple recipients</p>

                <div class="form-row" style="grid-template-columns: 1fr;">
                    <div class="form-group">
                        <label>Email Recipients (comma-separated)</label>
                        <textarea id="recipientEmails" placeholder="email1@example.com, email2@example.com, email3@example.com" style="min-height: 100px;"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email Subject</label>
                        <input type="text" id="sendSubject" placeholder="Email subject">
                    </div>
                </div>

                <div class="form-row" style="grid-template-columns: 1fr;">
                    <div class="form-group">
                        <label>Email Body</label>
                        <textarea id="sendBody" placeholder="Email content" style="min-height: 200px;"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Your Gmail Address</label>
                        <input type="email" id="senderEmail" placeholder="your-email@gmail.com">
                    </div>
                    <div class="form-group">
                        <label>Gmail App Password</label>
                        <input type="password" id="senderPassword" placeholder="App password (not regular password)">
                    </div>
                </div>

                <div class="info message" style="display: block;">
                    <strong>‚ÑπÔ∏è Note:</strong> Use Gmail App Password, not your regular password. 
                    <a href="https://support.google.com/accounts/answer/185833" target="_blank" style="color: inherit; text-decoration: underline;">Generate one here</a>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="sendEmails()">Send Campaign</button>
                    <button class="btn-secondary" onclick="pasteFromDraft()">üìã Use Draft</button>
                </div>

                <div class="message error" id="sendErrorMsg"></div>
                <div class="message success" id="sendSuccessMsg"></div>

                <div class="loading" id="sendLoading">
                    <div class="spinner"></div>
                    <p>Sending emails...</p>
                </div>

                <div class="send-results" id="sendResults"></div>
            </div>
        </div>

        <div style="text-align: center; color: rgba(255, 255, 255, 0.8); margin-top: 30px; font-size: 0.9em;">
            <p>Made with ‚ù§Ô∏è using Node.js + ScrapingBee API</p>
        </div>
    </div>

    <script>
        let scrapedEmails = [];
        let generatedEmailDraft = '';

        // Tab switching
        function switchTab(tabName, btnElement) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            btnElement.classList.add('active');
        }

        // Scrape emails
        async function scrapeEmails() {
            const url = document.getElementById('urlInput').value.trim();

            if (!url) {
                showMessage('errorMsg', 'Please enter a valid URL');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showMessage('errorMsg', 'URL must start with http:// or https://');
                return;
            }

            document.getElementById('loading').classList.add('active');
            clearMessage('errorMsg');
            clearMessage('successMsg');
            document.getElementById('results').innerHTML = '';

            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to scrape website');
                }

                scrapedEmails = data.emails || [];

                if (scrapedEmails.length === 0) {
                    showMessage('successMsg', 'No emails found on this website');
                    displayResults([]);
                } else {
                    showMessage('successMsg', `Successfully scraped ${scrapedEmails.length} email(s)!`);
                    displayResults(scrapedEmails);
                    document.getElementById('exportBtn').disabled = false;
                }
            } catch (error) {
                showMessage('errorMsg', 'Error: ' + error.message);
                console.error('Error:', error);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // Generate email draft
        async function generateEmailDraft() {
            const subject = document.getElementById('emailSubject').value.trim();
            const company = document.getElementById('targetCompany').value.trim();
            const purpose = document.getElementById('emailPurpose').value.trim();

            if (!subject || !company || !purpose) {
                showMessage('draftErrorMsg', 'Please fill in all fields');
                return;
            }

            document.getElementById('draftLoading').classList.add('active');
            clearMessage('draftErrorMsg');
            clearMessage('draftSuccessMsg');

            try {
                const response = await fetch('/api/generate-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        subject, 
                        targetCompany: company, 
                        purpose 
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate email');
                }

                generatedEmailDraft = data.emailDraft;
                showMessage('draftSuccessMsg', 'Email draft generated successfully!');
                
                const draftHtml = `
                    <div class="results-info">
                        <div class="results-count">Subject: <span>${escapeHtml(data.subject)}</span></div>
                    </div>
                    <div class="email-draft">${escapeHtml(generatedEmailDraft)}</div>
                    <button class="btn-primary" onclick="copyDraftToSend()">üìã Use in Campaign</button>
                `;
                document.getElementById('draftResult').innerHTML = draftHtml;
            } catch (error) {
                showMessage('draftErrorMsg', 'Error: ' + error.message);
            } finally {
                document.getElementById('draftLoading').classList.remove('active');
            }
        }

        // Copy draft to send section
        function copyDraftToSend() {
            const subject = document.getElementById('emailSubject').value;
            document.getElementById('sendSubject').value = subject;
            document.getElementById('sendBody').value = generatedEmailDraft;
            document.getElementById('send').classList.add('active');
            document.getElementById('scrape').classList.remove('active');
            document.getElementById('draft').classList.remove('active');
            showMessage('sendSuccessMsg', 'Draft copied to campaign section!');
        }

        // Paste from draft
        function pasteFromDraft() {
            if (!generatedEmailDraft) {
                showMessage('sendErrorMsg', 'Generate a draft first in the Draft Email tab');
                return;
            }
            copyDraftToSend();
        }

        // Send emails
        async function sendEmails() {
            const emailsText = document.getElementById('recipientEmails').value.trim();
            const subject = document.getElementById('sendSubject').value.trim();
            const body = document.getElementById('sendBody').value.trim();
            const senderEmail = document.getElementById('senderEmail').value.trim();
            const senderPassword = document.getElementById('senderPassword').value.trim();

            if (!emailsText || !subject || !body || !senderEmail || !senderPassword) {
                showMessage('sendErrorMsg', 'Please fill in all fields');
                return;
            }

            const emailAddresses = emailsText.split(',').map(e => e.trim()).filter(e => e);

            if (emailAddresses.length === 0) {
                showMessage('sendErrorMsg', 'Please enter valid email addresses');
                return;
            }

            document.getElementById('sendLoading').classList.add('active');
            clearMessage('sendErrorMsg');
            clearMessage('sendSuccessMsg');
            document.getElementById('sendResults').innerHTML = '';

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        emailAddresses,
                        subject,
                        emailBody: body,
                        senderEmail,
                        senderPassword
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to send emails');
                }

                showMessage('sendSuccessMsg', 
                    `Campaign sent! ${data.totalSent} sent, ${data.totalFailed} failed`);

                const resultsHtml = data.results.map(result => `
                    <div class="send-result-item ${result.status}">
                        <div>
                            <strong>${escapeHtml(result.email)}</strong>
                            <br>
                            <small>${result.status === 'sent' ? '‚úì Sent' : '‚úó Failed: ' + result.error}</small>
                        </div>
                    </div>
                `).join('');

                document.getElementById('sendResults').innerHTML = resultsHtml;
            } catch (error) {
                showMessage('sendErrorMsg', 'Error: ' + error.message);
            } finally {
                document.getElementById('sendLoading').classList.remove('active');
            }
        }

        // Display results
        function displayResults(emails) {
            if (emails.length === 0) {
                document.getElementById('results').innerHTML = '<div class="no-results">No emails found</div>';
                return;
            }

            let html = `
                <div class="results-info">
                    <div class="results-count">Found <span>${emails.length}</span> email(s)</div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Email Address</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            emails.forEach((email, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="email-cell">${escapeHtml(email)}</td>
                        <td>
                            <button class="action-btn" onclick="copyToClipboard('${escapeHtml(email)}')">üìã Copy</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            document.getElementById('results').innerHTML = html;
        }

        // Export to CSV
        function exportToCSV() {
            if (scrapedEmails.length === 0) {
                showMessage('errorMsg', 'No emails to export');
                return;
            }

            const headers = ['Email Address', 'Scraped Date'];
            const currentDate = new Date().toLocaleString();
            
            let csv = headers.join(',') + '\n';
            scrapedEmails.forEach(email => {
                csv += `"${email}","${currentDate}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `emails_${new Date().getTime()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage('successMsg', 'CSV exported successfully!');
        }

        // Utility functions
        function showMessage(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('active');
        }

        function clearMessage(elementId) {
            const el = document.getElementById(elementId);
            el.classList.remove('active');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            scrapedEmails = [];
            document.getElementById('urlInput').value = '';
            document.getElementById('exportBtn').disabled = true;
            clearMessage('errorMsg');
            clearMessage('successMsg');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('successMsg', 'Email copied to clipboard!');
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Save draft function
        function saveDraftPrompt() {
            if (!generatedEmailDraft) {
                showMessage('draftErrorMsg', 'Generate a draft first before saving');
                return;
            }

            const subject = document.getElementById('emailSubject').value.trim();
            if (!subject) {
                showMessage('draftErrorMsg', 'Subject is required to save');
                return;
            }

            const filename = prompt('Enter a name to save this draft:', subject);
            if (!filename) return;

            saveDraft(subject, generatedEmailDraft, filename);
        }

        // Save draft to server
        async function saveDraft(subject, emailBody, filename) {
            try {
                const response = await fetch('/api/save-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject,
                        emailBody,
                        filename
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save draft');
                }

                showMessage('draftSuccessMsg', `‚úÖ Draft saved as "${filename}"`);
            } catch (error) {
                showMessage('draftErrorMsg', 'Error: ' + error.message);
            }
        }

        // Show loaded drafts
        async function showLoadedDrafts() {
            try {
                const response = await fetch('/api/saved-emails');
                const data = await response.json();

                if (!response.ok || !data.emails) {
                    showMessage('draftErrorMsg', 'No saved drafts found');
                    return;
                }

                if (data.emails.length === 0) {
                    showMessage('draftErrorMsg', 'No saved drafts yet. Generate and save one first!');
                    return;
                }

                let html = '<div style="margin-top: 30px;"><h3 style="color: #333; margin-bottom: 15px;">üìÇ Your Saved Drafts</h3>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';

                data.emails.forEach(email => {
                    html += `
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 10px;">${escapeHtml(email.filename)}</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="action-btn" onclick="loadDraft('${email.filename}')" style="flex: 1;">üì• Load</button>
                                <button class="action-btn" onclick="deleteDraft('${email.filename}')" style="flex: 1; background: #f44336; color: white;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                document.getElementById('savedDraftsPanel').innerHTML = html;
            } catch (error) {
                showMessage('draftErrorMsg', 'Error: ' + error.message);
            }
        }

        // Load draft
        async function loadDraft(filename) {
            try {
                const response = await fetch(`/api/load-email/${filename}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load draft');
                }

                generatedEmailDraft = data.email.body;
                document.getElementById('emailSubject').value = data.email.subject;
                document.getElementById('sendSubject').value = data.email.subject;
                document.getElementById('sendBody').value = data.email.body;

                // Display the loaded draft
                const draftHtml = `
                    <div class="results-info">
                        <div class="results-count">Subject: <span>${escapeHtml(data.email.subject)}</span></div>
                    </div>
                    <div class="email-draft">${escapeHtml(generatedEmailDraft)}</div>
                    <button class="btn-primary" onclick="copyDraftToSend()">üìã Use in Campaign</button>
                `;
                document.getElementById('draftResult').innerHTML = draftHtml;
                document.getElementById('saveDraftBtn').disabled = false;

                showMessage('draftSuccessMsg', `‚úÖ Draft "${filename}" loaded successfully`);
            } catch (error) {
                showMessage('draftErrorMsg', 'Error: ' + error.message);
            }
        }

        // Delete draft
        async function deleteDraft(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-email/${filename}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete draft');
                }

                showMessage('draftSuccessMsg', `‚úÖ Draft "${filename}" deleted`);
                showLoadedDrafts(); // Refresh the list
            } catch (error) {
                showMessage('draftErrorMsg', 'Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
